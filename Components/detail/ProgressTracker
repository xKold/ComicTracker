import React, { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Star, Heart, BookOpen, Plus, Minus } from "lucide-react";
import { motion } from "framer-motion";

export default function ProgressTracker({ 
  comic, 
  userProgress, 
  onChapterUpdate, 
  onFavoriteToggle, 
  onRatingChange 
}) {
  const [currentChapter, setCurrentChapter] = useState(userProgress?.current_chapter || 0);
  const [isEditingChapter, setIsEditingChapter] = useState(false);

  const progressPercentage = comic.total_chapters 
    ? ((userProgress?.current_chapter || 0) / comic.total_chapters) * 100 
    : 0;

  const handleChapterChange = (newChapter) => {
    const validChapter = Math.max(0, Math.min(newChapter, comic.total_chapters));
    setCurrentChapter(validChapter);
    onChapterUpdate(validChapter);
  };

  const handleStarClick = (rating) => {
    onRatingChange(rating);
  };

  return (
    <div className="space-y-4">
      {/* Progress Card */}
      <Card className="border-purple-800/30 shadow-lg shadow-purple-900/20 bg-slate-900/50 backdrop-blur">
        <CardHeader>
          <CardTitle className="text-lg flex items-center gap-2 text-purple-300">
            <BookOpen className="w-5 h-5 text-purple-400" />
            Reading Progress
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Progress Bar */}
          <div>
            <div className="flex justify-between text-sm mb-2">
              <span className="text-purple-300/70">Progress</span>
              <span className="font-semibold text-purple-400">{Math.round(progressPercentage)}%</span>
            </div>
            <div className="h-3 bg-slate-950/50 rounded-full overflow-hidden border border-purple-900/30">
              <motion.div
                initial={{ width: 0 }}
                animate={{ width: `${progressPercentage}%` }}
                transition={{ duration: 0.5 }}
                className="h-full bg-gradient-to-r from-purple-500 to-fuchsia-500 rounded-full"
              />
            </div>
          </div>

          {/* Chapter Counter */}
          <div className="bg-gradient-to-br from-purple-900/20 to-fuchsia-900/20 rounded-xl p-4 border border-purple-800/30">
            <p className="text-sm text-purple-300/70 mb-2 text-center">Current Chapter</p>
            <div className="flex items-center justify-center gap-3">
              <Button
                size="icon"
                variant="outline"
                onClick={() => handleChapterChange((userProgress?.current_chapter || 0) - 1)}
                disabled={!userProgress?.current_chapter || userProgress.current_chapter === 0}
                className="border-purple-700/50 hover:bg-purple-900/30 text-purple-300"
              >
                <Minus className="w-4 h-4" />
              </Button>
              
              {isEditingChapter ? (
                <Input
                  type="number"
                  min="0"
                  max={comic.total_chapters}
                  value={currentChapter}
                  onChange={(e) => setCurrentChapter(parseInt(e.target.value) || 0)}
                  onBlur={() => {
                    handleChapterChange(currentChapter);
                    setIsEditingChapter(false);
                  }}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      handleChapterChange(currentChapter);
                      setIsEditingChapter(false);
                    }
                  }}
                  className="w-24 text-center text-2xl font-bold bg-slate-950/50 border-purple-800/50 text-purple-200"
                  autoFocus
                />
              ) : (
                <button
                  onClick={() => setIsEditingChapter(true)}
                  className="text-3xl font-bold text-purple-300 hover:text-purple-200 transition-colors min-w-[60px] text-center"
                >
                  {userProgress?.current_chapter || 0}
                </button>
              )}
              
              <span className="text-2xl text-purple-500/50">/</span>
              <span className="text-2xl font-semibold text-purple-300">{comic.total_chapters}</span>
              
              <Button
                size="icon"
                variant="outline"
                onClick={() => handleChapterChange((userProgress?.current_chapter || 0) + 1)}
                disabled={userProgress?.current_chapter >= comic.total_chapters}
                className="border-purple-700/50 hover:bg-purple-900/30 text-purple-300"
              >
                <Plus className="w-4 h-4" />
              </Button>
            </div>
          </div>

          {/* Quick Actions */}
          <div className="grid grid-cols-2 gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => handleChapterChange((userProgress?.current_chapter || 0) + 1)}
              disabled={userProgress?.current_chapter >= comic.total_chapters}
              className="border-purple-700/50 hover:bg-purple-900/30 text-purple-300"
            >
              Mark Next Chapter
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={() => handleChapterChange(comic.total_chapters)}
              className="border-purple-700/50 hover:bg-purple-900/30 text-purple-300"
            >
              Mark Completed
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Rating & Favorite */}
      <Card className="border-purple-800/30 shadow-lg shadow-purple-900/20 bg-slate-900/50 backdrop-blur">
        <CardContent className="pt-6 space-y-4">
          {/* Favorite */}
          <div>
            <Button
              variant="outline"
              onClick={onFavoriteToggle}
              className={`w-full ${
                userProgress?.is_favorite 
                  ? 'bg-gradient-to-r from-yellow-900/30 to-orange-900/30 border-yellow-700/50 text-yellow-300 hover:from-yellow-900/50 hover:to-orange-900/50' 
                  : 'border-purple-700/50 hover:bg-purple-900/30 text-purple-300'
              }`}
            >
              <Heart 
                className={`w-4 h-4 mr-2 ${
                  userProgress?.is_favorite ? 'fill-yellow-400 text-yellow-400' : ''
                }`} 
              />
              {userProgress?.is_favorite ? 'Remove from Favorites' : 'Add to Favorites'}
            </Button>
          </div>

          {/* Rating */}
          <div>
            <p className="text-sm text-purple-300/70 mb-3 text-center">Your Rating</p>
            <div className="flex justify-center gap-1">
              {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((rating) => (
                <button
                  key={rating}
                  onClick={() => handleStarClick(rating)}
                  className="group transition-transform hover:scale-110"
                >
                  <Star
                    className={`w-6 h-6 transition-colors ${
                      userProgress?.rating && rating <= userProgress.rating
                        ? 'fill-yellow-400 text-yellow-400'
                        : 'text-purple-700 group-hover:text-yellow-300'
                    }`}
                  />
                </button>
              ))}
            </div>
            {userProgress?.rating && (
              <p className="text-center text-sm text-purple-300/70 mt-2">
                {userProgress.rating}/10
              </p>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}